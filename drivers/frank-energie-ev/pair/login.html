<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EV Charger - Frank Energie Login</title>
</head>
<body>
  <homey-pair>
    <h1>EV Oplader</h1>
    <p>Inloggen met je Frank Energie account</p>

    <form>
      <div class="row">
        <label for="email">E-mailadres</label>
        <input id="email" type="email" required placeholder="jij@example.com" />
        <small>Uw Frank Energie account e-mailadres</small>
      </div>

      <div class="row">
        <label for="password">Wachtwoord</label>
        <input id="password" type="password" required placeholder="••••••••" />
        <small>Uw Frank Energie account wachtwoord</small>
      </div>

      <button type="submit" class="positive">Volgende</button>
    </form>
  </homey-pair>

  <script>
    Homey.setTitle('EV Oplader - Login');

    const form = document.querySelector('form');
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const email = emailInput.value.trim();
      const password = passwordInput.value;

      if (!email || !password) {
        Homey.showDialog('error', {
          title: 'Vul alle velden in',
          body: 'Email en wachtwoord zijn verplicht.',
        });
        return;
      }

      try {
        // Verify credentials and create device directly
        const result = await Homey.emit('verify_charger', {
          email,
          password,
        });

        if (result && result.sessionCount > 0) {
          // Device verified, create it directly with default charge limit
          await Homey.emit('list_devices', {
            email,
            password,
            chargeLimit: 16, // Default charge limit (adjustable in settings)
          });
        } else {
          Homey.showDialog('error', {
            title: 'Geen EV-oplader gevonden',
            body: 'Zorg dat je EV is gekoppeld via Enode in je Frank Energie account.',
          });
        }
      } catch (error) {
        Homey.showDialog('error', {
          title: 'Inloggen mislukt',
          body: error.message || 'Er is een fout opgetreden. Probeer opnieuw.',
        });
      }
    });

    emailInput.focus();
  </script>
</body>
</html>
